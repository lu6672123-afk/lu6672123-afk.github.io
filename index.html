<!doctype html>
exportXlsxBtn.disabled = !enabled;
exportCsvBtn.disabled = !enabled;
clearListBtn.disabled = !enabled;
}


function clearFields(){
[nameEl, titleEl, companyEl, emailEl, phoneEl].forEach(el=>el.value='');
rawEl.value='';
}


function toCSV(rows){
const header = ['姓名','職稱','公司','Email','電話'];
const lines = [header.join(',')].concat(rows.map(r=>header.map(h=>`"${(r[h]||'').replace(/\"/g,'\"\"')}"`).join(',')));
return lines.join('\n');
}


function exportExcel(){
const ws = XLSX.utils.json_to_sheet(contacts);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Contacts');
XLSX.writeFile(wb, `名片清單_${new Date().toISOString().slice(0,10)}.xlsx`);
}


function exportCSV(){
const blob = new Blob([toCSV(contacts)], { type:'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url; a.download = `名片清單_${new Date().toISOString().slice(0,10)}.csv`;
a.click(); URL.revokeObjectURL(url);
}


openCamBtn.addEventListener('click', openCamera);


snapBtn.addEventListener('click', async () => {
setProgress(0);
snapBtn.disabled = true;
try {
const img = captureFromVideo();
if(!img) return;
const text = await doOCR(img);
fillFields(extractFields(text));
} catch(e){
alert('辨識失敗：' + e.message + '\n建議改為「從相簿上傳」或在更明亮環境重試。');
} finally {
snapBtn.disabled = false;
}
});


fileInput.addEventListener('change', async (e)=>{
const file = e.target.files?.[0];
if(!file) return;
setProgress(0);
preview.src = '';
preview.style.display='none';
try {
const dataURL = await readAsDataURL(file);
preview.src = dataURL; preview.style.display='block';
const text = await doOCR(dataURL);
fillFields(extractFields(text));
} catch(e){
alert('辨識失敗：' + e.message);
}
});


addToListBtn.addEventListener('click', ()=>{
const rec = getCurrentRecord();
const empty = Object.values(rec).every(v=>!v);
if(empty){ alert('目前資料是空的，請先辨識或輸入。'); return; }
contacts.push(rec);
refreshTable();
clearFields();
});


clearFieldsBtn.addEventListener('click', clearFields);
exportXlsxBtn.addEventListener('click', exportExcel);
exportCsvBtn.addEventListener('click', exportCSV);
clearListBtn.addEventListener('click', ()=>{ if(confirm('確定要清空清單嗎？')){ contacts=[]; refreshTable(); }});


window.addEventListener('beforeunload', () => { if(stream){ stream.getTracks().forEach(t=>t.stop()); } });
</script>
</body>
</html>
